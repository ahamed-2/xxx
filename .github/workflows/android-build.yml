name: MyEyeSafeTelegramDemo CI

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Print repo tree (top levels)
        run: |
          echo "=== PWD ==="
          pwd
          echo "=== LS ==="
          ls -la
          echo "=== FIND settings.gradle ==="
          find . -maxdepth 4 -type f -name "settings.gradle" -print
          echo "=== FIND app/build.gradle ==="
          find . -maxdepth 6 -type f -path "*/app/build.gradle" -print

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Detect Android project directory (must have settings.gradle + app/build.gradle)
        id: detect
        run: |
          set -e
          # Prefer directories that contain BOTH settings.gradle and app/build.gradle
          CANDIDATE="$(find . -type f -name settings.gradle -print -quit)"
          if [ -z "$CANDIDATE" ]; then
            echo "❌ settings.gradle not found"
            exit 1
          fi

          # Try each settings.gradle dir until app/build.gradle exists beside it
          FOUND=""
          while IFS= read -r s; do
            d="$(dirname "$s")"
            if [ -f "$d/app/build.gradle" ] || [ -f "$d/app/build.gradle.kts" ]; then
              FOUND="$d"
              break
            fi
          done < <(find . -type f -name settings.gradle -print)

          if [ -z "$FOUND" ]; then
            echo "❌ Could not find a project folder that has BOTH settings.gradle and app/build.gradle"
            echo "settings.gradle files:"
            find . -type f -name settings.gradle -print
            echo "app/build.gradle files:"
            find . -type f -path "*/app/build.gradle" -print
            exit 1
          fi

          echo "✅ PROJECT_DIR=$FOUND"
          echo "project_dir=$FOUND" >> $GITHUB_OUTPUT

      - name: Show settings.gradle + app/build.gradle (detected)
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: |
          echo "=== settings.gradle ==="
          cat settings.gradle
          echo "=== app/build.gradle ==="
          cat app/build.gradle

      - name: Generate Gradle Wrapper (Gradle 8.2) if missing
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: |
          if [ ! -f "./gradlew" ]; then
            gradle wrapper --gradle-version 8.2
          fi

      - name: Give gradlew permission
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: chmod +x ./gradlew

      - name: Gradle projects + tasks (debug)
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: |
          ./gradlew projects
          ./gradlew :app:tasks --all || true

      - name: Build Debug APK
        working-directory: ${{ steps.detect.outputs.project_dir }}
        run: ./gradlew :app:assembleDebug --stacktrace --info

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: MyEyeSafeTelegramDemo-debug-apk
          path: |
            **/app/build/outputs/apk/debug/*.apk
